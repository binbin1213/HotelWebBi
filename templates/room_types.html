{% extends "base.html" %}

{% block title %}乐巷酒店 - 房型管理{% endblock %}

{% block content %}
<div class="w-full max-w-6xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">房型管理</h1>
        <div class="flex gap-2">
            <a href="/" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">返回主页</a>
        </div>
    </div>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                    <div class="p-4 mb-2 {% if '错误' in message or '失败' in message %}bg-red-100 text-red-700{% elif '成功' in message %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-800{% endif %} rounded-md">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- 添加房型表单 -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4">添加新房型</h2>

        <!-- 消息提示区域 -->
        <div id="message-area" class="mb-4 hidden">
            <div id="success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded hidden">
                <span id="success-text"></span>
            </div>
            <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded hidden">
                <span id="error-text"></span>
            </div>
        </div>

        <form id="add-room-type-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <div>
                <label for="type_name" class="block text-sm font-medium text-gray-700 mb-1">房型名称</label>
                <input type="text" id="type_name" name="type_name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="如：标准间">
            </div>
            <div>
                <label for="type_code" class="block text-sm font-medium text-gray-700 mb-1">房型代码</label>
                <input type="text" id="type_code" name="type_code" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="如：STD">
            </div>
            <div>
                <label for="base_price" class="block text-sm font-medium text-gray-700 mb-1">基础价格</label>
                <input type="number" id="base_price" name="base_price" step="0.01" min="0"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="200.00">
            </div>
            <div>
                <label for="room_count" class="block text-sm font-medium text-gray-700 mb-1">房间数量</label>
                <input type="number" id="room_count" name="room_count" min="0"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                       placeholder="10">
            </div>
            <div class="flex items-end">
                <button type="submit" id="submit-btn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    添加房型
                </button>
            </div>
        </form>
        <div class="mt-4">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1">房型描述</label>
            <input type="text" id="description" name="description"
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   placeholder="房型详细描述（可选）">
        </div>
    </div>

    <!-- 房型列表 -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">现有房型</h2>
        </div>
        
        {% if room_types %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">房型名称</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">房型代码</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">描述</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">基础价格</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">房间数量</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for room_type in room_types %}
                    <tr class="hover:bg-gray-50" data-room-id="{{ room_type[0] }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ room_type[1] }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ room_type[2] }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ room_type[3] or '-' }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">¥{{ "%.2f"|format(room_type[4]) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ room_type[5] }}间</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                活跃
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editRoomType({{ room_type[0] }}, '{{ room_type[1] }}', '{{ room_type[2] }}', '{{ room_type[3] or '' }}', {{ room_type[4] }}, {{ room_type[5] }})"
                                    class="text-indigo-600 hover:text-indigo-900 mr-3">编辑</button>
                            <button onclick="deleteRoomType({{ room_type[0] }}, '{{ room_type[1] }}')"
                                    class="text-red-600 hover:text-red-900">删除</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="px-6 py-8 text-center">
            <div class="text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">暂无房型</h3>
                <p class="mt-1 text-sm text-gray-500">开始添加您的第一个房型吧</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 使用说明 -->
    <div class="mt-6 bg-blue-50 p-4 rounded-md">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">房型管理说明</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <ul class="list-disc pl-5 space-y-1">
                        <li>房型代码会自动生成，也可以手动指定简短的英文缩写</li>
                        <li>基础价格用于参考，实际价格可能因渠道和日期而异</li>
                        <li>房间数量用于统计和分析，建议与实际房间配置保持一致</li>
                        <li><strong>自动识别：</strong>在Excel导入时，如果包含"房型"列，系统会自动创建新的房型</li>
                        <li><strong>数据分析：</strong>房型信息对收入分析、定价策略、市场偏好分析很有价值</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑房型模态框 -->
    <div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">编辑房型</h3>
                <form id="editForm">
                    <input type="hidden" id="editRoomId" name="room_id">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">房型名称</label>
                        <input type="text" id="editName" name="name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">房型代码</label>
                        <input type="text" id="editTypeCode" name="type_code" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">基础价格</label>
                        <input type="number" id="editBasePrice" name="base_price" step="0.01" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">房间数量</label>
                        <input type="number" id="editRoomCount" name="room_count" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">房型描述</label>
                        <textarea id="editDescription" name="description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">取消</button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('add-room-type-form');
    const submitBtn = document.getElementById('submit-btn');
    const messageArea = document.getElementById('message-area');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const successText = document.getElementById('success-text');
    const errorText = document.getElementById('error-text');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // 禁用提交按钮
        submitBtn.disabled = true;
        submitBtn.textContent = '添加中...';

        // 隐藏之前的消息
        messageArea.classList.add('hidden');
        successMessage.classList.add('hidden');
        errorMessage.classList.add('hidden');

        // 收集表单数据
        const formData = new FormData();
        formData.append('name', document.getElementById('type_name').value);
        formData.append('type_code', document.getElementById('type_code').value);
        formData.append('base_price', document.getElementById('base_price').value);
        formData.append('room_count', document.getElementById('room_count').value);
        formData.append('description', document.getElementById('description').value);

        // 发送AJAX请求
        fetch('/room_types/add', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            messageArea.classList.remove('hidden');

            if (data.success) {
                successText.textContent = data.message;
                successMessage.classList.remove('hidden');

                // 清空表单
                form.reset();

                // 1.5秒后刷新页面以显示新添加的房型
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                errorText.textContent = data.message || '添加失败，请重试';
                errorMessage.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageArea.classList.remove('hidden');
            errorText.textContent = '网络错误，请重试';
            errorMessage.classList.remove('hidden');
        })
        .finally(() => {
            // 恢复提交按钮
            submitBtn.disabled = false;
            submitBtn.textContent = '添加房型';
        });
    });

    // 编辑房型模态框相关函数
    const editForm = document.getElementById('editForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append('room_id', document.getElementById('editRoomId').value);
            formData.append('name', document.getElementById('editName').value);
            formData.append('type_code', document.getElementById('editTypeCode').value);
            formData.append('base_price', document.getElementById('editBasePrice').value);
            formData.append('room_count', document.getElementById('editRoomCount').value);
            formData.append('description', document.getElementById('editDescription').value);

            fetch('/room_types/edit', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.message || '编辑失败，请重试');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('网络错误，请重试');
            });
        });
    }
});

// 编辑房型函数
function editRoomType(id, name, typeCode, description, basePrice, roomCount) {
    document.getElementById('editRoomId').value = id;
    document.getElementById('editName').value = name;
    document.getElementById('editTypeCode').value = typeCode;
    document.getElementById('editDescription').value = description || '';
    document.getElementById('editBasePrice').value = basePrice;
    document.getElementById('editRoomCount').value = roomCount;

    document.getElementById('editModal').classList.remove('hidden');
}

// 关闭编辑模态框
function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

// 删除房型函数
function deleteRoomType(id, name) {
    if (confirm(`确定要删除房型"${name}"吗？此操作不可恢复。`)) {
        const formData = new FormData();
        formData.append('room_id', id);

        fetch('/room_types/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert(data.message || '删除失败，请重试');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('网络错误，请重试');
        });
    }
}
</script>
{% endblock %}
